name: Build Android (Release APK + AAB)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            build-essential \
            git \
            zip \
            unzip \
            autoconf \
            automake \
            libtool \
            pkg-config \
            cmake \
            ninja-build \
            gettext \
            libssl-dev \
            libffi-dev \
            python3-dev \
            libsqlite3-dev \
            liblzma-dev \
            libbz2-dev \
            libreadline-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo6 \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            libjpeg-dev \
            libpng-dev \
            zlib1g-dev

      - name: Install Python dependencies (pinned stable)
        run: |
          python -m ensurepip --upgrade
          python -m pip install --upgrade pip setuptools wheel virtualenv
          python -m pip install \
            buildozer==1.5.0 \
            cython==0.29.36 \
            kivy==2.1.0 \
            kivymd==0.104.2 \
            plyer==2.1.0 \
            requests

      - name: Ensure app assets exist (icon/presplash)
        run: |
          set -e
          mkdir -p assets
          if [ ! -f assets/presplash.png ]; then
            echo "ERROR: assets/presplash.png not found" >&2
            ls -la assets || true
            exit 1
          fi
          if [ ! -f assets/icon.png ]; then
            echo "assets/icon.png missing, trying to generate from assets/icon.ico..."
            if [ -f assets/icon.ico ]; then
              python -m pip install --no-cache-dir pillow
              python -c "from PIL import Image; img = Image.open('assets/icon.ico'); img.save('assets/icon.png'); print('Generated assets/icon.png from assets/icon.ico')"
            else
              echo "ERROR: assets/icon.png not found and assets/icon.ico not found" >&2
              ls -la assets || true
              exit 1
            fi
          fi
          ls -la assets

      - name: Prepare release keystore (from GitHub Secrets)
        # Secrets are NOT provided to pull_request runs (especially from forks).
        if: github.event_name != 'pull_request'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "BASE64 is set? yes"
          else
            echo "BASE64 is set? no"
          fi

          echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"
          echo "ANDROID_KEYSTORE_BASE64 length=${#ANDROID_KEYSTORE_BASE64}"
          echo "ANDROID_KEYSTORE_PASSWORD length=${#ANDROID_KEYSTORE_PASSWORD}"
          echo "ANDROID_KEY_ALIAS length=${#ANDROID_KEY_ALIAS}"
          echo "ANDROID_KEY_ALIAS_PASSWORD length=${#ANDROID_KEY_ALIAS_PASSWORD}"

          if [ -z "$ANDROID_KEYSTORE_BASE64" ] || [ -z "$ANDROID_KEYSTORE_PASSWORD" ] || [ -z "$ANDROID_KEY_ALIAS" ] || [ -z "$ANDROID_KEY_ALIAS_PASSWORD" ]; then
            echo "ERROR: Missing one or more required secrets: ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_ALIAS_PASSWORD" >&2
            exit 1
          fi

          mkdir -p .keystore
          printf '%s' "$ANDROID_KEYSTORE_BASE64" | base64 --decode > .keystore/release.keystore
          chmod 600 .keystore/release.keystore

          python -c "import os; from pathlib import Path; spec=Path('buildozer.spec'); text=spec.read_text(encoding='utf-8'); text=text.replace('__ANDROID_KEYSTORE_PASSWORD__', os.environ['ANDROID_KEYSTORE_PASSWORD']).replace('__ANDROID_KEY_ALIAS__', os.environ['ANDROID_KEY_ALIAS']).replace('__ANDROID_KEY_ALIAS_PASSWORD__', os.environ['ANDROID_KEY_ALIAS_PASSWORD']); spec.write_text(text, encoding='utf-8')"

      - name: Build Release APK
        if: github.event_name != 'pull_request'
        run: |
          set -e
          export CFLAGS="$CFLAGS -Wno-macro-redefined"
          export CXXFLAGS="$CXXFLAGS -Wno-macro-redefined"

          # 只构建 APK（可直接安装测试）
          buildozer -v android release

          if ! ls -1 bin/*.apk >/dev/null 2>&1; then
            echo "ERROR: APK not generated. Please check build logs." >&2
            ls -la bin || true
            exit 1
          fi

          # 复制一个“固定文件名”的 APK 便于下载（保留原始 apk 文件不删除）
          APK_SRC=$(ls -1 bin/*.apk | head -n 1)
          cp -f "$APK_SRC" "bin/晨曦智能打卡.apk"

          ls -la bin

      - name: Build Debug (PR without secrets)
        if: github.event_name == 'pull_request'
        run: |
          set -e
          buildozer -v android debug
          ls -la bin || true

      - name: Upload Release artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          # 只要 bin 下至少存在一个文件（AAB 或 APK）就会上传成功
          # 避免因某个文件不存在导致 workflow 失败
          path: |
            bin/*.aab
            bin/*.apk
            bin/晨曦智能打卡.aab
            bin/晨曦智能打卡.apk
          retention-days: 30
          compression-level: 0

      - name: Debug info on failure (list build dirs)
        if: failure()
        run: |
          echo "PWD=$(pwd)"
          ls -la
          echo "---- .buildozer (top) ----"
          ls -la .buildozer || true
          echo "---- find .buildozer (depth 5) ----"
          find .buildozer -maxdepth 5 -type d -print || true

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug
          if-no-files-found: ignore
          path: |
            .buildozer/**
            bin/**
            buildozer.spec
          retention-days: 7
          compression-level: 0
